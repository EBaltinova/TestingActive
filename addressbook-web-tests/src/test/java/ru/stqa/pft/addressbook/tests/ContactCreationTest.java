package ru.stqa.pft.addressbook.tests;// Generated by Selenium IDE

import com.fasterxml.jackson.databind.MappingIterator;
import com.fasterxml.jackson.dataformat.csv.CsvMapper;
import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import com.thoughtworks.xstream.XStream;
import org.openqa.selenium.By;
import org.testng.ITestContext;
import org.testng.annotations.DataProvider;
import org.testng.annotations.Test;
import org.testng.asserts.SoftAssert;
import ru.stqa.pft.addressbook.appmanager.ContactHelper;
import ru.stqa.pft.addressbook.model.ContactData;
import ru.stqa.pft.addressbook.model.Contacts;

import java.io.*;
import java.util.*;
import java.util.stream.Collectors;

import static org.hamcrest.CoreMatchers.equalTo;
import static org.hamcrest.MatcherAssert.assertThat;

public class ContactCreationTest extends TestBase {

    public List<ContactData> validContactsFromXml(String path) throws IOException {
        try (BufferedReader reader = new BufferedReader(new FileReader(new File(path)))) {
            StringBuilder xml = new StringBuilder();
            String line = reader.readLine();

            while (line != null) {
                xml.append(line);
                line = reader.readLine();
            }

            XStream xstream = new XStream();
            xstream.processAnnotations(ContactData.class);

            return (List<ContactData>) xstream.fromXML(xml.toString());
        }
    }

    public List<ContactData> validContactsFromCsv(String path) throws IOException {
        CsvMapper mapper = new CsvMapper();
        MappingIterator<ContactData> personIter = mapper.readerWithTypedSchemaFor(ContactData.class).readValues(new FileReader(path));

        return personIter.readAll();
    }

    public List<ContactData> validContactsFromJson(String path) throws IOException {
        try (BufferedReader reader = new BufferedReader(new FileReader(path))) {
            StringBuilder json = new StringBuilder();
            String line = reader.readLine();

            while (line != null) {
                json.append(line);
                line = reader.readLine();
            }

            Gson gson = new Gson();

            return gson.fromJson(json.toString(), new TypeToken<List<ContactData>>() {
            }.getType());
        }
    }

    @DataProvider
    public Iterator<Object[]> validContacts(ITestContext context) throws Exception {
        String format = context.getCurrentXmlTest().getAllParameters().getOrDefault("format", null);
        List<ContactData> contacts;
        switch (format) {
            case "csv":
                contacts = validContactsFromCsv("src/test/resources/contactsAll.csv");
                break;
            case "xml":
                contacts = validContactsFromXml("src/test/resources/contactsAll.xml");
                break;
            case "json":
                contacts = validContactsFromJson("src/test/resources/contactsAll.json");
                break;
            default:
                throw new Exception("Задан неверный формат файла");
        }

        return contacts.stream().map((g) -> new Object[]{g}).collect(Collectors.toList()).iterator();
    }


    @Test(dataProvider = "validContacts")
    public void testContactCreation(ContactData contact) {
        ContactHelper contactHelper = app.contact();
        SoftAssert softAssert = new SoftAssert();
        Contacts before = app.db().contacts();

        assertThat("Add new contact button is not available", contactHelper.isClickable(By.linkText("add new")));
        contactHelper.initContactCreation();

        Arrays
                .asList("bday", "bmonth", "aday", "amonth", "photo", "submit")
                .forEach((String elementName) -> {
                    String message = String.format("Element <%s> is not available", elementName);
                    softAssert.assertTrue(contactHelper.isClickable(By.name(elementName)), message);
                });

        softAssert.assertTrue(contactHelper.isClickable(By.cssSelector("input:nth-child(87)")), "Submit button is not available");
        softAssert.assertAll();

        contactHelper.fillContactForm(contact, true);
        contactHelper.submitContactCreation();
        app.goTo().homePage();
        Contacts after = app.db().contacts();
        assertThat(after, equalTo(before.withAdded(contact.withId(after.stream().mapToInt((c) -> c.getId()).max().getAsInt()))));
        verifyContactListInUI();
    }
}


